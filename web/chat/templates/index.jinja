{% extends "base.jinja" %}

{% block head %}
<link rel="stylesheet" href="{{ static('pages/index.css') }}">
{% endblock %}

{% block body %}
<main>

  <div id="sidebar">
  </div>

  <div id="chatContainer">
    <div id="chat">
      <div id="chatMessagesContainer">
      </div>

      <div id="chatInputContainer">
        <textarea id="chatInput" placeholder="Ask a question"></textarea>
        <button id="chatSubmit">â–²</button>
      </div>
    </div>
  </div>

</main>

<script>
{
  const UserMessage = (message) =>
    van.tags.div(
      { class: "user-message" },
      message.text,
    );

  const BotMessage = (message) =>
    van.tags.div(
      { class: "bot-message" },
      message.text,
    );

  class ChatArea {
    constructor() {
      // state
      this.messages = van.state([]);

      // init
      this.initUI();
    }

    initUI() {
      this.ui = {};

      this.ui.chatInput = document.getElementById("chatInput");
      this.ui.chatInput.addEventListener("input",  this.adjustChatInputHeight.bind(this));
      this.ui.chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          this.submitMessage();
        }
      });
      this.adjustChatInputHeight(); // call to prevent height jump when initially typing

      this.ui.chatSubmit = document.getElementById("chatSubmit");
      this.ui.chatSubmit.addEventListener("click", () => {
        this.submitMessage();
      });

      this.ui.chatMessagesContainer = document.getElementById("chatMessagesContainer");
      van.add(
        this.ui.chatMessagesContainer,
        () => van.tags.div(
          { id: "chatMessages" },
          this.messages.val.map(
            message =>
              message.fromUser
                ? UserMessage(message)
                : BotMessage(message)
          )
        )
      );
      van.derive(() => {
        this.messages.val;
        setTimeout(this.scrollToLastMessage.bind(this), 0);
      });
    }

    scrollToLastMessage() {
      this.ui.chatMessagesContainer.scrollTop = this.ui.chatMessagesContainer.scrollHeight;
      const lastMessage = document.getElementById("chatMessages").lastChild;
      if (!lastMessage) return;
      lastMessage.scrollIntoView({ block: "start" });
    }

    adjustChatInputHeight() {
      this.ui.chatInput.style.height = 'auto'; // force height reset
      const newHeight = Math.min(this.ui.chatInput.scrollHeight, 200);
      this.ui.chatInput.style.height = newHeight + 'px';
    }

    submitMessage() {
      const userMessage = this.ui.chatInput.value.trim();
      if (!userMessage) return;

      this.ui.chatInput.value = "";
      this.adjustChatInputHeight();

      this.messages.val = [
        ...this.messages.val,
        { fromUser: true, text: userMessage },
      ];

      setTimeout(() => {
        this.messages.val = [
          ...this.messages.val,
          { fromUser: false, text: userMessage },
        ];
      }, 500);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    new ChatArea();
  });
}
</script>
{% endblock %}
